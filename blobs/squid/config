acl tls-ports port 443
acl http-ports port 80 443
acl CONNECT method CONNECT
acl safe-methods method GET POST OPTIONS HEAD CONNECT
http_access deny !http-ports
http_access deny CONNECT !tls-ports
http_access allow localhost manager
http_access deny manager
http_access deny to_localhost
http_access deny to_linklocal

acl crlocsp-r url_regex ocsp.* crl.*
acl crlocsp-d dstdomain .pki.goog .lencr.org
http_access allow safe-methods crlocsp-r
http_access allow safe-methods crlocsp-d

acl nixos-src src 10.85.10.1 # RMNMVNFDNS01
acl nixos-src src 10.85.10.2 # RMNMVNFDNS02
acl nixos-src src 10.85.10.5 # RMNMVNOCMT01
acl nixos-src src 10.85.20.7 # RMNMVNTPSRV01
acl nixos-src src 10.85.20.8 # RMNMVYTARC
acl nixos-src src 10.85.20.11 # RMNMVMGNIX
acl nixos-src src 10.85.101.17 # RMNMVATPKI
acl nixos dstdomain cache.nixos.org tarballs.nixos.org channels.nixos.org code.rmntn.net
acl github dstdomain github.com api.github.com codeload.github.com raw.githubusercontent.com github-production-release-asset-2e65be.s3.amazonsaws.com objects.githubusercontent.com
acl golang dstdomain proxy.golang.org storage.googleapis.com
acl rust-crates dstdomain crates.io static.crates.io
acl debian dstdomain deb.debian.org security.debian.org extrepo-team.pages.debian.net dl.cloudsmith.io
http_access allow safe-methods nixos-src nixos
http_access allow safe-methods nixos-src github
http_access allow safe-methods nixos-src golang
http_access allow safe-methods nixos-src rust-crates

acl dns src 10.85.10.1 10.85.10.2
acl technitium dstdomain go.technitium.com download.technitium.com packages.microsoft.com
acl blocking-lists dstdomain s3.amazonaws.com raw.githubusercontent.com v.firebog.net adaway.org gitlab.com hostfiles.frogeye.fr osint.digitalside.it bitbucket.org phishing.army urlhaus.abuse.ch zerodot1.gitlab.io
http_access allow safe-methods dns technitium
http_access allow safe-methods dns blocking-lists

acl wsus src 10.85.11.4
acl ms-update dstdomain "/etc/squid/acl/wsus"
http_access allow safe-methods wsus ms-update

acl fss04 src 10.81.70.18
acl ixsystems dstdomain update-master.ixsystems.com update.ixsystems.com update.freenas.org pkg.freebsd.org
http_access allow safe-methods fss04 ixsystems
http_access allow safe-methods fss04 github

acl kms src 10.85.20.2
acl slitaz dstdomain mirror.slitaz.org mirror1.slitaz.org
http_access allow safe-methods kms slitaz

acl mgmt-workstation src 10.85.20.1
acl nix-mgmt-workstation src 10.85.20.11
acl powershell-gallery dstdomain .nuget.org devopsgallerystorage.blob.core.windows.net go.microsoft.com onegetcdn.azureedge.net psg-prod-eastus.azureedge.net www.powershellgallery.com
acl vscode dstdomain az764295.vo.msecnd.net marketplace.visualstudio.com ms-vscode-remote.gallery.vsassets.io ms-vscode-remote.gallerycdn.vsassets.io update.code.visualstudio.com
http_access allow safe-methods mgmt-workstation powershell-gallery
http_access allow safe-methods mgmt-workstation github
http_access allow safe-methods mgmt-workstation vscode
http_access allow safe-methods mgmt-workstation debian
http_access allow safe-methods nix-mgmt-workstation vscode

acl youtube-archiver src 10.85.20.8
acl jellyfin dstdomain repo.jellyfin.org sgp1.mirror.jellyfin.org
acl docker dstdomain download.docker.com ghcr.io pkg-containers.githubusercontent.com hub.docker.com
acl twitch dstdomain .twitch.tv static-cdn.jtvnw.net .ttvnw.net .twitchcdn.net d1m7jfoe9zdc1j.cloudfront.net
acl youtube dstdomain .youtube.com .googlevideo.com .ytimg.com .youtu.be
http_access allow safe-methods youtube-archiver jellyfin
http_access allow safe-methods youtube-archiver docker
http_access allow safe-methods youtube-archiver twitch
http_access allow safe-methods youtube-archiver youtube

acl entra-connect src 10.85.11.3
acl veeam src 10.85.20.3
acl entra-id dstdomain "/etc/squid/acl/entra-id"
acl exchange-online dstdomain "/etc/squid/acl/exchange-online"
http_access allow safe-methods entra-connect entra-id
http_access allow safe-methods entra-connect powershell-gallery
http_access allow safe-methods veeam exchange-online

cache deny all
http_access deny all

httpd_suppress_version_string on
follow_x_forwarded_for allow localhost
follow_x_forwarded_for deny all
forwarded_for delete
request_header_access X-Forwarded-For deny all
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all

http_port 10.85.20.10:3128 connection-auth=off

buffered_logs on
strip_query_terms on
logformat custom_log %{%Y-%m-%d %H:%M:%S}tl %>a:%>p %Ss/%03>Hs:%Sh "%rm %ru HTTP/%rv" %mt %>Hs %<st %tr "%{User-Agent}>h" "%{Referer}>h"
logformat rfc5424 <36>1 %{%Y-%m-%dT%H:%M:%S%z}tl %<A Squid - %master_xaction [request@99999 act="%Ss" uri="%ru" ct="%mt" rc="%>Hs" rs="%<st" rt="%tr" ua="%{User-Agent}>h"]
pid_filename /run/squid.pid
cache_effective_user squid squid
cache_log stdio:/var/log/squid/cache.log
access_log stdio:/var/log/squid/access.log logformat=custom_log
